name: Deploy / master

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to deploy (must be master)"
        required: true
        default: "master"

jobs:
  verify_ci:
    name: Verify latest CI success on master
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    env:
      NODE_ENV: production
    steps:
      - name: Ensure CI workflow succeeded on master
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.inputs?.ref !== "master") {
              core.setFailed("This workflow can only deploy the master branch.");
              return;
            }
            const { owner, repo } = context.repo;
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: "ci.yml",
              branch: "master",
              status: "completed",
              per_page: 1,
            });
            const latest = runs.data.workflow_runs[0];
            if (!latest || latest.conclusion !== "success") {
              core.setFailed("Latest CI workflow run on master is not successful.");
              return;
            }
            core.info(`Latest CI run ${latest.id} concluded: ${latest.conclusion}`);

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: verify_ci
    env:
      NODE_ENV: production
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Prepare Node environment
        uses: ./.github/actions/node-bootstrap
        with:
          node-version: 22.14.0

      - name: Build for Cloudflare Pages
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }} --branch=master
