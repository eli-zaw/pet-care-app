name: PR / lint-test-e2e

on:
  pull_request: {}

jobs:
  lint:
    name: Lint code
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Node environment
        uses: ./.github/actions/node-bootstrap
        with:
          node-version: 22.14.0

      - name: Run linter
        run: npm run lint

  unit_test:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: lint
    env:
      NODE_ENV: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Node environment
        uses: ./.github/actions/node-bootstrap
        with:
          node-version: 22.14.0

      - name: Run unit tests with coverage
        run: npm run test -- --coverage

      - name: Upload unit coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: coverage/

  e2e_test:
    name: E2E tests
    runs-on: ubuntu-latest
    needs: lint
    env:
      NODE_ENV: integration
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
      E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Node environment
        uses: ./.github/actions/node-bootstrap
        with:
          node-version: 22.14.0

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chrome

      - name: Create .env.testing for E2E
        run: |
          cat <<'EOF' > .env.testing
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          E2E_USERNAME=${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD=${{ secrets.E2E_PASSWORD }}
          NODE_ENV=integration
          EOF

      - name: Start app server
        run: npm run dev:e2e -- --mode integration --host 127.0.0.1 --port 4173 & echo $! > /tmp/astro.pid

      - name: Wait for app to be ready
        run: |
          for i in {1..60}; do
            if nc -z 127.0.0.1 4173; then
              echo "Server is ready"
              exit 0
            fi
            sleep 2
          done
          echo "Server did not start in time"
          exit 1

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-coverage
          path: |
            tests/e2e/report/
            tests/e2e/results/

      - name: Stop app server
        if: always()
        run: |
          if [ -f /tmp/astro.pid ]; then
            kill "$(cat /tmp/astro.pid)" || true
          fi

  status_comment:
    name: PR status comment
    runs-on: ubuntu-latest
    needs: [lint, unit_test, e2e_test]
    if: ${{ success() && github.event_name == 'pull_request' }}
    steps:
      - name: Comment on PR status
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const body = [
              "âœ… CI status: all checks passed.",
              "- Lint: passed",
              "- Unit tests: passed",
              "- E2E tests: passed"
            ].join("\n");
            await github.rest.issues.createComment({ owner, repo, issue_number, body });
